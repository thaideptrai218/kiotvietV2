name: Claude Code with z.ai

on:
    issue_comment:
        types: [created]
    pull_request_review_comment:
        types: [created]

permissions:
    contents: write
    pull-requests: write
    issues: write

jobs:
    claude-code:
        runs-on: ubuntu-latest
        if: contains(github.event.comment.body, '@claude')
        timeout-minutes: 10

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install Claude Code CLI
              run: npm install -g @anthropic-ai/claude-code

            - name: Cache GitHub CLI
              id: cache-gh
              uses: actions/cache@v3
              with:
                  path: |
                      /usr/local/bin/gh
                      /usr/share/doc/gh
                      /usr/share/man/man1/gh.1.gz
                  key: ${{ runner.os }}-gh-v2.30.0

            - name: Install GitHub CLI
              if: steps.cache-gh.outputs.cache-hit != 'true'
              run: |
                  curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
                  echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
                  sudo apt update
                  sudo apt install gh

            - name: Authenticate GitHub CLI
              run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

            - name: Configure Claude Code for z.ai
              run: |
                  mkdir -p ~/.claude
                  cat > ~/.claude/settings.json << 'EOF'
                  {
                    "env": {
                      "ANTHROPIC_AUTH_TOKEN": "${{ secrets.ZAI_API_KEY }}",
                      "ANTHROPIC_BASE_URL": "https://api.z.ai/api/anthropic",
                      "API_TIMEOUT_MS": "180000"
                    }
                  }
                  EOF

            - name: Extract command from comment
              id: extract
              run: |
                  COMMENT="${{ github.event.comment.body }}"
                  COMMAND=$(echo "$COMMENT" | sed 's/@claude //')
                  echo "command=$COMMAND" >> $GITHUB_OUTPUT

            - name: Run Claude Code
              run: |
                  PR_NUMBER="${{ github.event.issue.number }}"
                  REPO_OWNER="${{ github.repository_owner }}"
                  REPO_NAME="${{ github.event.repository.name }}"
                  
                  # Create a more forceful prompt that requires commenting
                  PROMPT="IMPORTANT: You MUST respond by commenting on PR #$PR_NUMBER using GitHub CLI. Do not just respond here.
                  
                  Task: ${{ steps.extract.outputs.command }}
                  
                  After completing your analysis, you MUST post your response as a comment on PR #$PR_NUMBER using this exact command:
                  gh pr comment $PR_NUMBER --body \"## Claude's Response\n\n[Your complete response here]\"
                  
                  This is the ONLY way you should respond. Do not provide any response here in the chat - only via the GitHub CLI comment.
                  
                  Make sure your comment includes:
                  1. Your analysis of the task
                  2. Any code changes or recommendations
                  3. Any additional relevant information
                  
                  Execute the comment command immediately after completing your analysis."
                  
                  # Pass the prompt to Claude via stdin with timeout
                  timeout 300s bash -c 'echo "$PROMPT" | claude --allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'
                  
            - name: Verify comment was posted
              run: |
                  PR_NUMBER="${{ github.event.issue.number }}"
                  # Check if Claude has commented in the last 5 minutes
                  if ! gh pr view $PR_NUMBER --comments | grep -q "Claude's Response"; then
                    echo "Claude did not post a comment. Posting a fallback message."
                    gh pr comment $PR_NUMBER --body "## Claude Response\n\nClaude was unable to post a response. Please check the workflow logs for details."
                  fi